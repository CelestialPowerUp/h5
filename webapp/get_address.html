<!doctype html><!--[if lte IE 9]>
<html class="lte9 no-js m"><![endif]--><!--[if gt IE 9]><!-->
<html class="no-js m"><!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no;">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta name="renderer" content="webkit">
    <title>获取地址</title>
    <meta name="description" content="">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="./css/amazeui.min.css">
    <link rel="stylesheet" href="./css/h5.css">

    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./js/handlebars.min.js"></script>
    <script type="text/javascript" src="./js/amazeui.min.js"></script>
    <script type="text/javascript" src="./js/common.js"></script>

</head>
<body class="body-background-color-gray">
<header data-am-widget="header" class="am-header am-header-default am-header-fixed body-background-color-white">
    <div class="am-header-left am-header-nav">
        <a href="./my_address_manage.html">
            <img src="./img/back_green.png">
        </a>
    </div>
    <h1 class="am-header-title">
        位置信息
    </h1>

    <div class="am-header-right am-header-nav">
        <!--<button  class="am-btn am-btn-success" id="search_button" style="background-color: #09be00;border-radius: 5px;margin-top: 12px; ">搜索</button>-->
        <button class="am-btn am-btn-success address-getter-header-btn" id="locate_button">
            确定
        </button>
    </div>
</header>
<hr data-am-widget="divider" class="am-divider am-divider-default margin-0"/>

<div class="address-getter-search-input-div">
    <input id="search_input" class="address-getter-search-input" placeholder="输入查询的地址"/>
</div>

<div id="map_view" class="address-getter-map-view"></div>
<script src="http://api.map.baidu.com/api?v=2.0&ak=WVAXZ05oyNRXS5egLImmentg"></script>
<script type="text/javascript">!function (t) {
    t(function () {
        t('#map_view').css('height', (t(window).height() - t('header').height()) + 'px');

        var location_info = getLocation();
        console.log(location_info);
        var map = new BMap.Map('map_view');
        var point = new BMap.Point(116.404, 39.915);
        map.centerAndZoom(point, 15);
        map.enableScrollWheelZoom(true);
        /*var marker = new BMap.Marker(point);  // 创建标注
         map.addOverlay(marker);               // 将标注添加到地图中
         marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画*/
        map.panTo(point);

        var top_right_navigation = new BMap.NavigationControl({
            offset: new BMap.Size(15, 65),
            type: BMAP_NAVIGATION_CONTROL_ZOOM
        });
        map.addControl(top_right_navigation);

        var geolocationControl = new BMap.GeolocationControl({offset: new BMap.Size(15, 65), enableAutoLocation: true});

        geolocationControl.addEventListener("locationSuccess", function (e) {
            // 定位成功事件
            var address = '';
            address += e.addressComponent.city;
            address += e.addressComponent.district;
            address += e.addressComponent.street;
            address += e.addressComponent.streetNumber;
            location_info.name = e.addressComponent.city;
            location_info.address = address;
            location_info.latitude = e.point.lat;
            location_info.longitude = e.point.lng;
            location_info.point = e.point;
            updateLocationInfo();
        });
        geolocationControl.addEventListener("locationError", function (e) {
            // 定位失败事件
            alert(e.message);
        });
        map.addControl(geolocationControl);

        var updateLocationInfo = function () {
            map.clearOverlays();    //清除地图上所有覆盖物
            var cpoint = new BMap.Point(location_info.longitude, location_info.latitude);
            map.centerAndZoom(cpoint, 18);
            var marker = new BMap.Marker(cpoint);
            var opts = {
                width: 200,    // 信息窗口宽度
                height: 70,     // 信息窗口高度
                offset: new BMap.Size(0, -25),
                title: "标题：" + location_info.name, // 信息窗口标题
                enableAutoPan: true, //自动平移
                enableMessage: false
            };
            var infoWindow = new BMap.InfoWindow("地址：" + location_info.address, opts);  // 创建信息窗口对象
            map.openInfoWindow(infoWindow, cpoint); //开启信息窗口
            marker.addEventListener("click", function () {
                map.openInfoWindow(infoWindow, cpoint); //开启信息窗口
            });
            map.addOverlay(marker);   //添加标注
        };

        function initAddressInfo() {
            if (location_info.address === "") {
                geolocationControl.location();
            } else {
                updateLocationInfo();
            }
        }

        setTimeout(initAddressInfo, 2000);
        //$("#search_input").val("dasds");
        //initAddressInfo();

        $("#locate_button").click(function () {
            location_info = location_info || {};
            location_info['name'] = location_info['name'] || '';
            location_info['address'] = $('#search_input').val();

            if ('' === location_info['address']) {
                show_msg('地址不能为空');
            }

            var param = {
                address_name: location_info['name'],
                address: location_info['address'],
                longitude: location_info['longitude'],
                latitude: location_info['latitude'],
                user_id: getUser()['user_id']
            };
            postReq('address/create', param, function(data) {
                go_back_to_reload();
            });
        });

        /*$("#search_button").click(function(){
         $("#search_input").val();
         });*/

        var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
                {
                    "input": "search_input",
                    "location": map
                });

        ac.addEventListener("onhighlight", function (e) {  //鼠标放在下拉列表上的事件
            var str = "";
            var _value = e.fromitem.value;
            var value = "";
            if (e.fromitem.index > -1) {
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

            value = "";
            if (e.toitem.index > -1) {
                _value = e.toitem.value;
                value = _value.province + _value.city + _value.district + _value.street + _value.business;
            }
            str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
            $("#searchResultPanel").innerHTML = str;
        });

        var myValue;
        ac.addEventListener("onconfirm", function (e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
            $("#searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

            setPlace();
            disable_button('locate_button');
        });

        function setPlace() {
            location_info = {};
            function myFun() {
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                location_info.latitude = pp.lat;
                location_info.longitude = pp.lng;
                location_info.name = local.getResults().getPoi(0).title;
                location_info.address = local.getResults().getPoi(0).address;
                location_info.point = pp;
                updateLocationInfo();

                reset_button('locate_button');
            }

            var local = new BMap.LocalSearch(map, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(myValue);
        }
    })
}(window.jQuery);</script>
</body>
</html><!-- Cached page generated on Thu Apr 09 2015 02:58:25 GMT+0000 (UTC) -->