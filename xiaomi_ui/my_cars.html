<!doctype html><!--[if lte IE 9]>
<html class="lte9 no-js m"><![endif]--><!--[if gt IE 9]><!-->
<html class="no-js m"><!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta name="renderer" content="webkit">
    <title>我的车</title>
    <meta name="description" content="">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="./css/amazeui.min.css">
    <link rel="stylesheet" href="./css/h5.css">

</head>
<body class="body-background-color-gray">
<div class="new-bottom-button-div">
    <a href="./car_choose.html">
        <button class="am-btn am-btn-success am-btn-block new-bottom-button">
            <!--<i class="am-icon-plus"></i>-->
            添加一款车型
        </button>
    </a>
</div>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script type="text/javascript" src="./js/handlebars.min.js"></script>
<script type="text/javascript" src="./js/amazeui.min.js"></script>
<script type="text/javascript" src="./js/router.js"></script>
<script type="text/x-handlebars-template" id="carinfo_list_tpl">
    <ul class="am-list my-list">
        {{#each this}}
        <!--缩略图在标题左边-->
        <li class="carinfo my-list-line" data-rel="{{car_id}}">
            <div class="carinfo-btn am-vertical-align car-manager-clickable" data-rel="{{car_id}}">
                <div class="am-vertical-align-middle my-thumb-icon-wrapper">
                    <img src="{{img_url}}" class="my-thumb-icon">
                </div>
                <div class="my-list-line-content am-vertical-align-middle">
                    <h3 class="am-list-item-hd">{{{car_number}}}</h3>
                    <div class="am-list-item-text fixed-width-content">{{{model}}}</div>
                </div>
            </div>
            <div class="delete-btn am-vertical-align car-manager-deletable" data-rel="{{car_id}}">
                <img class="am-vertical-align-middle car-manager-deletable-img" src="./img/delete.png">
            </div>
        </li>
        {{/each}}
    </ul>
</script>
<script type="text/javascript">!function (t) {
    t(function () {

        getStore().set('now_in', 'my_cars');

//        var raw_data = '';
//        var data = $.parseJSON(raw_data);

        getReq('cars.json?car_user_id=' + getUser()['user_id'], function (data) {
            var item = {};
            var tmpl_data = [];
            for (var i = 0; i < data.length; i++) {
                var view_data = {};
                view_data.car_id = data[i].id;
                view_data.car_model_type = data[i].model_type;
                view_data.img_url = data[i].brand_img_url.thumbnail_url;
                view_data.car_number = stripscript(data[i].licence.province + data[i].licence.number);
                view_data.model = data[i].model;
                tmpl_data.push(view_data);
                item[view_data.car_id] = data[i];
            }
            console.log(tmpl_data);

            var tpl = Handlebars.compile(t("#carinfo_list_tpl").text());
            t('body').prepend(tpl(tmpl_data));
            var base_ui = t('.car-manager-clickable').eq(0);
            var base_ui2 = base_ui.children('.my-list-line-content').eq(0);
            t('body').children().eq(0).find('.fixed-width-content').css('width', (t(window).width()
                    - base_ui.css('padding-left').match(/\d*/) * 2 - base_ui.height() * 0.6
                    - base_ui2.css('margin-left').match(/\d*/)) + 'px');

            t('.carinfo-btn').click(function (e) {
                var car = item[t(this).attr('data-rel')];
                getStore().set("car_info_m", car);

                window.location.href = './car_choose4.html';
            });

            t('.carinfo-btn').css('left', '0px');

            t('.delete-btn').click(function (e) {
                postReq('cars/delete', [t(this).attr('data-rel')], function(data) {
                    window.location.reload();
                });
            });

            var accepted = false, startX, now_offset, is_moving = false, interval, last_intention_target, last_intention;//true for left, false for right

            function accept(i) {
    //                    return (i < -140) ? false : ((i > 0) ? false : i);
    //                    return i;
                return (i > 0) ? false : i;//禁止右滑动出界
            }

            t('.carinfo').hammer().on('panstart', function(e) {
                console.log(e);
                console.log('touch start');
                if (Math.abs(90 - Math.abs(e['gesture']['angle'])) < 50) {
                    accepted = false;
                    return;
                }
                accepted = true;
                if (is_moving) {
                    clearInterval(interval);
                    is_moving = false;
                }
                startX = e['gesture']['pointers'][0]['pageX'];
                var carinfo_btn = t(this).find('.carinfo-btn').eq(0);
                now_offset = t(carinfo_btn).css('left');
                now_offset = parseFloat(now_offset.substr(0, now_offset.indexOf('px')));
                if (now_offset === 0) {
                    t('.carinfo-btn').css('left', '0px');//所有地址归位
                }
            });

            t('.carinfo').hammer().on('panmove', function(e) {
                if (!accepted) {
                    return;
                }
                console.log('touch move');
                var endX = e['gesture']['pointers'][0]['pageX'];
                t(this).find('.carinfo-btn').eq(0).css('left', accept(now_offset - (startX - endX)) + 'px');
                console.log('fade ing ...');
            });

            function move(carinfo_btn, from, to) {
                if (from > to) {
                    last_intention = true;
                } else if (from < to) {
                    last_intention = false;
                } else {
                    return;
                }
                last_intention_target = to;

                var times = Math.abs(from - to) + 125;

                function get_offset(x) {
                    function ifn(x) {
                        // 倍数不能小于
                        return Math.abs(Math.sin(x)) * times;
                    }
                    var number;
                    if (last_intention) {
                        number = from - ifn(x);
                        return number >= to ? number : false;
                    } else {
                        number = from + ifn(x);
                        return number <= to ? number : false;
                    }
                }

                var i = Math.PI / 100, step = Math.PI / 100;
                interval = setInterval(function() {
                    var offset = get_offset(i);
                    console.log(offset);
                    if (!offset) {
                        t(carinfo_btn).css('left', to + 'px');
                        clearInterval(interval);
                        is_moving = false;
                    } else {
                        t(carinfo_btn).css('left', offset + 'px');
                        i = i + step;
                    }
                }, 16);
                is_moving = true;
            }

            t('.carinfo').hammer().on('panend', function(e) {
                if (!accepted) {
                    return;
                }
                console.log('touch end');
                console.log(e);
                var endX = e['gesture']['pointers'][0]['pageX'];
                console.log(startX);
                console.log(endX);
                var carinfo_btn = t(this).find('.carinfo-btn').eq(0);
                now_offset = t(carinfo_btn).css('left');
                now_offset = parseFloat(now_offset.substr(0, now_offset.indexOf('px')));
                if (now_offset < (0 - t(window).width() / 2)) {
                    postReq('cars/delete', [t(this).attr('data-rel')], function (data) {
                        window.location.reload();
                    });
                } else {
                    if (now_offset === 0) {
                        t('.carinfo-btn').css('left', '0px');//所有地址归位
                    }
                    if ((startX - endX) > 0) {
                        move(carinfo_btn, now_offset, -70);
                        console.log('fade in');
                    } else if ((endX - startX) > 0) {
                        move(carinfo_btn, now_offset, 0);
                        console.log('fade out');
                    } else {
                        move(carinfo_btn, now_offset, last_intention_target);
                        console.log('continue');
                    }
                }
            });

        });

    });
}(window.jQuery);</script>
</body>
</html><!-- Cached page generated on Thu Apr 09 2015 02:58:25 GMT+0000 (UTC) -->