<!doctype html><!--[if lte IE 9]>
<html class="lte9 no-js m"><![endif]--><!--[if gt IE 9]><!-->
<html class="no-js m"><!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta name="renderer" content="webkit">
    <title>我的地址</title>
    <meta name="description" content="">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="./css/amazeui.min.css">
    <link rel="stylesheet" href="./css/swiper.min.css">
    <link rel="stylesheet" href="./css/h5.css">
</head>
<body class="body-background-color-gray">
<div class="new-bottom-button-div">
    <a href="./get_address.html">
        <button class="am-btn am-btn-success am-btn-block new-bottom-button">
            <!--<i class="am-icon-plus"></i>-->
            添加一个地址
        </button>
    </a>
</div>
<script type="text/x-handlebars-template" id="address_list_tpl">
    <ul class="am-list" style="margin-bottom: 150px;margin-top:30px;">
        {{#each this}}
        <li class="address am-nbfc address-manager-line" data-rel="{{id}}">
            <div class="am-vertical-align address-btn address-manager-clickable"
                 data-name="{{name}}" data-longitude="{{longitude}}" data-latitude="{{latitude}}">
                <span class="am-vertical-align-middle address-manager-clickable-text">
                    {{address}}
                </span>
            </div>
            <div class="delete-btn am-vertical-align address-manager-deletable" data-rel="{{id}}">
                <img class="am-vertical-align-middle address-manager-deletable-img" src="./img/delete.png">
            </div>
        </li>
        {{/each}}
    </ul>
</script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/amazeui.min.js"></script>
<script type="text/javascript" src="./js/handlebars.min.js"></script>
<script type="text/javascript" src="./js/swiper.min.js"></script>
<script type="text/javascript" src="./js/common.js"></script>
<script type="text/javascript" src="./js/router.js"></script>
<script type="text/javascript">!function (t) {
    if (t) {
        t(function () {

            route2address();

//            var raw_data = '{"code":"00000","data":[{"id":25,"address":"北京市海淀区北三环中路77号院-27号楼北京市海淀区北三环中路77号院-27号楼","longitude":116.364142,"latitude":39.977895,"user_id":18,"name":"北京市海淀区北三环中路77号院-27号楼"},{"id":24,"address":"北京市西城区百万庄南街10号院","longitude":116.345098,"latitude":39.931795,"user_id":18,"name":"北京市西城区百万庄南街10号院"},{"id":23,"address":"北京市海淀区西村路7号院-2号楼","longitude":116.380949,"latitude":39.978662,"user_id":18,"name":"北京市海淀区西村路7号院-2号楼"},{"id":22,"address":"北京市海淀区京师路","longitude":116.373008,"latitude":39.96976,"user_id":18,"name":"北京市海淀区京师路"},{"id":18,"address":"北京市昌平区X026(中东路)","longitude":116.395888,"latitude":40.061047,"user_id":18,"name":"北京市昌平区X026(中东路)"},{"id":17,"address":"北京市丰台区丰台南路","longitude":116.340606,"latitude":39.827867,"user_id":18,"name":"北京市丰台区丰台南路"},{"id":14,"address":"北京市海淀区京师路","longitude":116.371571,"latitude":39.96976,"user_id":18,"name":"北京市海淀区京师路"}]}';
//            var data = $.parseJSON(raw_data)['data'];

            getReq('addresses?user_id='+getUser()['user_id'], function(data){
                console.log(data);

                var tpl = Handlebars.compile(t("#address_list_tpl").text());
                t('body').prepend(tpl(data));

                t('.address-btn').click(function (e) {
                    if ('address_list' !== getStore().get('now_in')) {
                        var location_info = {};
                        location_info['longitude'] = t(this).attr('data-longitude');
                        location_info['latitude'] = t(this).attr('data-latitude');
                        location_info['name'] = t(this).attr('data-name');
                        location_info['address'] = t(this).find('span').eq(0).text();
                        updateLocation(location_info);
                        window.location.href = './base_info.html';
                    }
                });

                t('.delete-btn').click(function (e) {
                    postReq('addresses/delete', [t(this).attr('data-rel')], function(data) {
                        window.location.reload();
                    });
                });

                t('.address-btn').css('left', '0px');

                function accept(i) {
//                    return (i < -140) ? false : ((i > 0) ? false : i);
//                    return i;
                    return (i > 0) ? false : i;//禁止右滑动出界
                }

                var accepted = false, startX, now_offset, is_moving = false, interval, last_intention_target, last_intention;//true for left, false for right

                t('.address').hammer().on('panstart', function(e) {
                    console.log('touch start');
                    if (Math.abs(90 - Math.abs(e['gesture']['angle'])) < 50) {
                        accepted = false;
                        return;
                    }
                    accepted = true;
                    if (is_moving) {
                        clearInterval(interval);
                        is_moving = false;
                    }
                    startX = e['gesture']['pointers'][0]['pageX'];
                    var address_btn = t(this).find('.address-btn').eq(0);
                    now_offset = t(address_btn).css('left');
                    now_offset = parseFloat(now_offset.substr(0, now_offset.indexOf('px')));
                    if (now_offset === 0) {
                        t('.address-btn').css('left', '0px');//所有地址归位
                    }
                });

                t('.address').hammer().on('panmove', function(e) {
                    if (!accepted) {
                        return;
                    }
                    console.log('touch move');
                    var endX = e['gesture']['pointers'][0]['pageX'];
                    t(this).find('.address-btn').eq(0).css('left', accept(now_offset - (startX - endX)) + 'px');
                    console.log('fade ing ...');
                });

                function move(address_btn, from, to) {
                    if (from > to) {
                        last_intention = true;
                    } else if (from < to) {
                        last_intention = false;
                    } else {
                        return;
                    }
                    last_intention_target = to;

                    var times = Math.abs(from - to) + 125;

                    function get_offset(x) {
                        function ifn(x) {
                            // 倍数不能小于
                            return Math.abs(Math.sin(x)) * times;
                        }
                        var number;
                        if (last_intention) {
                            number = from - ifn(x);
                            return number >= to ? number : false;
                        } else {
                            number = from + ifn(x);
                            return number <= to ? number : false;
                        }
                    }

                    var i = Math.PI / 100, step = Math.PI / 100;
                    interval = setInterval(function() {
                        var offset = get_offset(i);
                        console.log(offset);
                        if (!offset) {
                            t(address_btn).css('left', to + 'px');
                            clearInterval(interval);
                            is_moving = false;
//                            swinging = true;
                        } else {
                            t(address_btn).css('left', offset + 'px');
                            i = i + step;
                        }
                    }, 16);
                    is_moving = true;
                }

                t('.address').hammer().on('panend', function(e) {
                    if (!accepted) {
                        return;
                    }
                    console.log('touch end');
                    console.log(e);
                    var endX = e['gesture']['pointers'][0]['pageX'];
                    console.log(startX);
                    console.log(endX);
                    var address_btn = t(this).find('.address-btn').eq(0);
                    now_offset = t(address_btn).css('left');
                    now_offset = parseFloat(now_offset.substr(0, now_offset.indexOf('px')));
                    if (now_offset < (0 - t(window).width() / 2)) {
                        postReq('addresses/delete', [t(this).attr('data-rel')], function (data) {
                            window.location.reload();
                        });
                    } else {
                        if (now_offset === 0) {
                            t('.address-btn').css('left', '0px');//所有地址归位
                        }
                        if ((startX - endX) > 0) {
                            move(address_btn, now_offset, -70);
                            console.log('fade in');
                        } else if ((endX - startX) > 0) {
                            move(address_btn, now_offset, 0);
                            console.log('fade out');
                        } else {
                            move(address_btn, now_offset, last_intention_target);
                            console.log('continue');
                        }
                    }
                });

            });

        });
    }
}(window.jQuery);
</script>
</body>
</html>